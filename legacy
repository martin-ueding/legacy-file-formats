#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2012 Martin Ueding <dev@martin-ueding.de>

import optparse
import os

# Dict of file extensions that should be checked. The full name is also there,
# but currently not used.
patterns = {
    "cdr": "Corel Draw",
    "doc": "Microsoft Word",
    "docx": "Microsoft Word",
    "indd": "Adobe InDesign",
    "key": "Apple Keynote",
    "mindnode": "Mindnode Mindmap",
    "mw": "Maple Worksheet",
    "nb": "Mathematica Notebook",
    "numbers": "Apple Numbers",
    "odg": "Open Office Draw",
    "odp": "Open Office Impress",
    "ods": "Open Office Calc",
    "odt": "Open Office Writer",
    "pages": "Apple Pages",
    "ppsx": "Microsoft PowerPoint",
    "ppt": "Microsoft PowerPoint",
    "ppts": "Microsoft PowerPoint",
    "pptx": "Microsoft PowerPoint",
    "rtfd": "Rich Text Format",
    "xls": "Microsoft Excel",
    "xlsx": "Microsoft Excel",
    "xoj": "Xournal"
}

def main():
    parser = optparse.OptionParser(usage="legacy [paths...]", description="Checks for proprietary or legacy file formats that do not have a PDF exported.")
    parser.add_option("--suffix", dest="suffix", default="pdf", help="Additional suffix to check for [default %default]")

    (options, args) = parser.parse_args()
    del parser

    options.suffix = options.suffix.lower()

    # If no directory was given on the command line, use the current working
    # directory.
    if len(args) == 0:
        args.append(".")

    # Iterate through all given folders.
    for arg in args:
        if os.path.isdir(arg):
            os.path.walk(arg, checkfolder, options)

def checkfolder(options, dirname, names):
    """
    Checks a folder for files that lack an export.

    In case `file.old` does not have a `file.old.pdf`, a `file.pdf` is checked
    alternatively. It the latter is found, it is moved to `file.old.pdf` to
    show that it is just an export of the original file, not a file on its own.
    """

    names.sort()

    # Iterate thorugh all the files and folders.
    for name in names:
        for pattern in patterns:
            if name.lower().endswith("."+pattern):
                # This is the standard PDF file name.
                pdffile = dirname+"/"+name+"."+options.suffix

                if not os.path.isfile(pdffile):
                    # Check whether the file has the same name, just a PDF extension.
                    alt_pdffile = dirname+"/"+os.path.splitext(name)[0]+"."+options.suffix
                    if os.path.isfile(alt_pdffile):
                        os.rename(alt_pdffile, pdffile)
                    
                    # Neither the regular nor the alternative export file
                    # exists, list this file.
                    else:
                        print dirname+"/"+name


if __name__ == "__main__":
	main()
